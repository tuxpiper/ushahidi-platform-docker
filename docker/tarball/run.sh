#!/bin/bash

cat <<'EOF'

                     .   .......?Z8888888888887+,?888888.......,...... ......   
                   . .....,=88888888888888888888888888888+8888888888........    
                   ....,Z888888888888888888888888888888888888888888888,......   
 . . ..  . ....   . ,+8888888888888888888888888888888888888888888888888$....    
.. ...............,?8888888888888888OZZZZZOO8888888888888888888888888888~..     
. ......... . ..,+888888888888ZI~:,.......,,~+I$O8888888888888888888888D8...    
 .:?88888:.....~88888888888$:....,?ZZ~IO$I7O7~:.,=7ZO88888888888888888888+...   
.,$8D88888...,I888888888O~...,Z8$777.DD88O77$778ZZ,,+$O888888888888888888I...   
 ~Z8888888..:788888888O~..:?=I88888D.:~+Z88D$I7?77$7=.=7O8888888888888888~..    
.,$O8888O:.:O888888887..:I?88888O=,$O.~888,Z8D+8=8I8+8+,?$88888888888888O...    
..,=77?~~$8888888888...+7:8888:.O8888D$..$8888$88:8O$8I,?,$Z888888888888..      
.....,7888D88888888:.,I$8==8+.O8O88888~,I.,78?O88O88O~DI=Z~7O8888888888+.. .    
...,ZD88888888888O..:+8888..8O8888887.Z8888O,..:7Z,8O?..DZ$,$O88888888.......   
..I88888888888888~.:$OO8Z.$.:888888::88888DO::88OO==O88=88O=:7O8888888,......   
:I88888888888888+.:I888Z.O88,.7D88.:8888888D.$8D888.8888.8D8=~Z8888888$.....    
7888888888888888..IZ88:,8D8888..:,788888888+:888888.88888.88$,IZ8888888:....    
8888888888888887.:$+8I~88888D887...7888888O.$888888=$8888O?887~78888888$....    
888888888888888:.?8,I.O888888O~.OOO=..I888:.8888888I~88888.O8=.+O8888888.. ..   
888888888888888.:78O.O88888887.+888888?,...:8888888Z.888D87:.~.~Z8888888.....   
88888888888888$.~$8$+.Z88888I.I8888888888=.~....:+7?.$$7=...O8~:Z8888888.....   
88888888888888$.=$8:8D..8888..88888888887.?88888887=.??7888,88~,Z8888888....    
88888888888888Z.=$8.888O..8,.88888888888..888888888=.888888=88,:Z8888888....    
Z88888888888888.:$8:888888..I8888888888Z.:888888888.=888888+D8.:Z8888888....    
$O8888888888888~,IO:888888....ID8888888~.$888888888.7888888~88.~O8888888....    
~7O888888888888$.+$.888888.=88?..~88D8I.=8888888887.8888888.8I,?8888888$....    
.,7Z888888888888.,$ZO8888=.888888Z,..~..8888888888,.888888Z:~.~78888888:....    
...~$Z8888888888?.+$7:8O8.=8888888888I....:+888888.~D8888$.,..IO8888887.....    
... .:?7ZO8888888=,+ZO~:8.O8888888888..8DDOZ?:..........I$II.~O8888888... ..    
      ..=$88888888..IZ88+.8O8D888888:.$888888888$.Z88888O.:.~$8888888$ ......   
      ...+Z88888888:,+Z88:Z.~D888888 .8888888888..8888DO~:.,Z8888888Z. .....    
      ....IZ88888888~.=7O8~888,.Z8D,.O8888888O8,,8888DO=..~Z88888888....  ...   
      ....,IO888888O88..?$??88888O..=Z888888D8..8888D~,..=888888888. ........   
           ,7Z8888888887..=7Z78888.:888$,,..:.~?:,~:...,O888888888..+O888887. ..
            .+Z888888888O7..:+$Z?:?8888888Z.78DZ?:...:O888888888I.=O888888888+..
            ..=$O88888888888,...~=?I7$$7$7I?~:....,?888888888888.+888888888888..
            . .:$O888888888D887:.......,........=Z8888888888888O~7888888888888+.
            ..  .=$O88888888888888887?====I$8888888888888888888+=Z888888888888?.
                . ,=$O8888888888888888888888888888888888888888$.~$888888888888..
                  ..+Z8888888888888888888888888888888888888888...+Z8888888888I..
                   ..+Z88888888888888888888888888888888888888:....+$O888888O....
                  .. .IZ888888888888888888888888888888888888...... .~+?I+~..... 
                    ...=Z888888888888888888888888888888888O.....     .     .    
                  ......~7O888888888888888888888888888888?......                
                  ........+$O888888888888888888888888887......                  
                      . ....+7ZO888888888888888888888+....                      
                             .:=7$O88888888888888Z~,.....                       
                            . . .:+I7$ZOO8OOZ7?=:........                       
                                                                 GlassGiant.com

(*) Welcome to Ushahidi Platform !

EOF

cat > /platform/api/.env <<EOF
DB_HOST=${MYSQL_PORT_3306_TCP_ADDR}
DB_NAME=${MYSQL_ENV_MYSQL_DATABASE}
DB_PASS=${MYSQL_ENV_MYSQL_PASSWORD}
DB_TYPE=MySQLi
DB_USER=${MYSQL_ENV_MYSQL_USER}
EOF

# Wait until MySQL is up
echo -n "Checking MySQL "
k=1; while [ "$k" -lt "60" ]; do
  if nc -w 1 ${MYSQL_PORT_3306_TCP_ADDR} 3306 > /dev/null < /dev/null ; then
    break;
  fi
  echo "."
  sleep 1;
  k=$((k + 1))
done
sleep 1;
echo

( cd /platform/api && ./bin/update --no-interaction )

if [ ! -z "$ACCESS_URL" ]; then
  cat > /platform/client/config.js <<EOF
window.ushahidi = {
  backendUrl : "${ACCESS_URL}/api"
};
EOF
fi

exec apachectl -DFOREGROUND
